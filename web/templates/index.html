<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prediction Market Arbitrage Monitor</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0e17;
            color: #e0e6ed;
            min-height: 100vh;
        }
        .header {
            background: linear-gradient(135deg, #1a1f2e 0%, #0d1117 100%);
            border-bottom: 1px solid #21262d;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            font-size: 20px;
            font-weight: 600;
            color: #f0f6fc;
        }
        .header h1 span { color: #58a6ff; }
        .header-info {
            display: flex;
            gap: 20px;
            font-size: 13px;
            color: #8b949e;
            align-items: center;
        }
        .header-info .val { color: #58a6ff; font-weight: 600; }

        /* WebSocket connection indicator */
        .ws-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            padding: 3px 10px;
            border-radius: 12px;
            background: #21262d;
        }
        .ws-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            transition: background 0.3s, box-shadow 0.3s;
        }
        .ws-dot.connected { background: #3fb950; box-shadow: 0 0 6px #3fb950; }
        .ws-dot.disconnected { background: #f85149; box-shadow: 0 0 6px #f85149; }
        .ws-dot.connecting { background: #d29922; box-shadow: 0 0 6px #d29922; animation: pulse 1s ease-in-out infinite; }

        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

        /* Platform status cards */
        .platforms {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }
        .platform-card {
            background: #161b22;
            border: 1px solid #21262d;
            border-radius: 12px;
            padding: 16px;
            transition: border-color 0.3s;
        }
        .platform-card.updated {
            border-color: #3fb950;
        }
        .platform-card .name {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            font-weight: 600;
            font-size: 15px;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        .status-dot.active { background: #3fb950; box-shadow: 0 0 6px #3fb950; }
        .status-dot.error { background: #f85149; box-shadow: 0 0 6px #f85149; }
        .status-dot.no_key { background: #d29922; box-shadow: 0 0 6px #d29922; }
        .status-dot.unknown { background: #484f58; }
        .platform-stats {
            display: flex;
            gap: 16px;
            font-size: 13px;
            color: #8b949e;
        }
        .platform-stats .num { color: #f0f6fc; font-weight: 600; }

        /* Arbitrage section */
        .section-title {
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .arb-table {
            width: 100%;
            border-collapse: collapse;
            background: #161b22;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #21262d;
            margin-bottom: 24px;
        }
        .arb-table th {
            background: #1c2128;
            padding: 10px 14px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: #8b949e;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .arb-table td {
            padding: 10px 14px;
            border-top: 1px solid #21262d;
            font-size: 13px;
        }
        .arb-table tr:hover td { background: #1c2128; }
        .arb-pct {
            font-weight: 700;
            font-size: 14px;
        }
        .arb-pct.high { color: #3fb950; }
        .arb-pct.mid { color: #d29922; }
        .arb-pct.low { color: #8b949e; }
        .net-pct { font-weight: 700; font-size: 14px; }
        .net-pct.high { color: #3fb950; }
        .net-pct.mid { color: #d29922; }
        .net-pct.low { color: #8b949e; }
        .tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }
        .tag.poly { background: #1f3a5f; color: #58a6ff; }
        .tag.opinion { background: #1f3a5f; color: #d29922; }
        .tag.predict { background: #1f3a5f; color: #9c27b0; }
        .tag.kalshi { background: #1f3a5f; color: #3fb950; }
        .tag.probable { background: #1f3a5f; color: #ff6b6b; }
        .tag.cross { background: #3a2a10; color: #ff9800; }
        .cross-combo-row td:first-child { border-left: 2px solid #ff980033; }
        .direction { font-size: 12px; color: #8b949e; }

        /* Price history sparkline */
        .sparkline { display: inline-block; vertical-align: middle; }
        .sparkline svg { overflow: visible; }

        /* Market list */
        .market-lists {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 16px;
        }
        .market-list {
            background: #161b22;
            border: 1px solid #21262d;
            border-radius: 12px;
            overflow: hidden;
        }
        .market-list-header {
            padding: 12px 14px;
            background: #1c2128;
            font-weight: 600;
            font-size: 14px;
            border-bottom: 1px solid #21262d;
        }
        .market-item {
            padding: 8px 14px;
            border-bottom: 1px solid #21262d;
            font-size: 12px;
        }
        .market-item:last-child { border-bottom: none; }
        .market-item .title {
            color: #c9d1d9;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .market-item .prices {
            display: flex;
            gap: 12px;
            color: #8b949e;
            font-size: 11px;
        }
        .market-item .prices .yes { color: #3fb950; }
        .market-item .prices .no { color: #f85149; }

        .empty-state {
            padding: 40px;
            text-align: center;
            color: #484f58;
        }
        .pulse { animation: pulse 2s ease-in-out infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* Multi-result Arbitrage */
        .multi-arb-table {
            width: 100%;
            border-collapse: collapse;
            background: #161b22;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #21262d;
            margin-bottom: 24px;
        }
        .multi-arb-table th {
            background: #1a1c2e;
            padding: 10px 14px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: #8b949e;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .multi-arb-table td {
            padding: 10px 14px;
            border-top: 1px solid #21262d;
            font-size: 13px;
            vertical-align: top;
        }
        .multi-arb-table tr:hover td { background: #1c2128; }
        .multi-arb-row { background: #0e111a; }
        .outcome-pill {
            display: inline-block;
            background: #1c2540;
            border: 1px solid #2d3a5e;
            border-radius: 6px;
            padding: 2px 8px;
            margin: 2px 3px 2px 0;
            font-size: 11px;
            white-space: nowrap;
        }
        .outcome-pill .outcome-name { color: #8b949e; }
        .outcome-pill .outcome-price { color: #58a6ff; font-weight: 600; margin-left: 4px; }
        .outcome-pills { line-height: 1.8; }
        .key-differences { display: flex; align-items: center; gap: 6px; font-size: 11px; }
        .key-diff-item { color: #d29922; font-weight: 500; background: #21262d; padding: 2px 6px; border-radius: 4px; }

        @media (max-width: 1024px) {
            .platforms, .market-lists { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 768px) {
            .platforms, .market-lists { grid-template-columns: 1fr; }
            .header { flex-direction: column; gap: 8px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Prediction Market <span>Arbitrage Monitor</span></h1>
        <div class="header-info">
            <div class="ws-indicator">
                <span class="ws-dot connecting" id="ws-dot"></span>
                <span id="ws-label">Connecting...</span>
            </div>
            <div>v3.4</div>
            <div>Scans: <span class="val" id="scan-count">0</span></div>
            <div>Threshold: <span class="val" id="threshold">2.0</span>%</div>
            <div>Updated: <span class="val" id="last-scan">-</span></div>
        </div>
    </div>

    <div class="container">
        <!-- Platform Status -->
        <div class="platforms">
            <div class="platform-card" id="card-polymarket">
                <div class="name">
                    <span class="status-dot unknown" id="dot-polymarket"></span>
                    Polymarket
                </div>
                <div class="platform-stats">
                    <div>Markets: <span class="num" id="count-polymarket">-</span></div>
                    <div>Status: <span class="num" id="status-polymarket">...</span></div>
                </div>
            </div>
            <div class="platform-card" id="card-opinion">
                <div class="name">
                    <span class="status-dot unknown" id="dot-opinion"></span>
                    Opinion.trade
                </div>
                <div class="platform-stats">
                    <div>Markets: <span class="num" id="count-opinion">-</span></div>
                    <div>Status: <span class="num" id="status-opinion">...</span></div>
                </div>
            </div>
            <div class="platform-card" id="card-predict">
                <div class="name">
                    <span class="status-dot unknown" id="dot-predict"></span>
                    Predict.fun
                </div>
                <div class="platform-stats">
                    <div>Markets: <span class="num" id="count-predict">-</span></div>
                    <div>Status: <span class="num" id="status-predict">...</span></div>
                </div>
            </div>
            <div class="platform-card" id="card-kalshi">
                <div class="name">
                    <span class="status-dot unknown" id="dot-kalshi"></span>
                    Kalshi
                </div>
                <div class="platform-stats">
                    <div>Markets: <span class="num" id="count-kalshi">-</span></div>
                    <div>Status: <span class="num" id="status-kalshi">...</span></div>
                </div>
            </div>
            <div class="platform-card" id="card-probable">
                <div class="name">
                    <span class="status-dot unknown" id="dot-probable"></span>
                    Probable.market
                </div>
                <div class="platform-stats">
                    <div>Markets: <span class="num" id="count-probable">-</span></div>
                    <div>Status: <span class="num" id="status-probable">...</span></div>
                </div>
            </div>
        </div>

        <!-- Scan Statistics -->
        <div class="scan-stats" id="scan-stats" style="display:none;margin-bottom:16px;background:#161b22;border:1px solid #21262d;border-radius:10px;padding:12px 20px;font-size:13px;color:#8b949e;display:flex;gap:24px;flex-wrap:wrap;align-items:center">
            <span>Scan <span class="val" id="stat-duration">-</span>s</span>
            <span>Markets: <span class="val" id="stat-total">-</span></span>
            <span style="color:#03a9f4">Poly <span class="val" id="stat-poly">-</span></span>
            <span style="color:#d29922">OP <span class="val" id="stat-op">-</span></span>
            <span style="color:#9c27b0">Pre <span class="val" id="stat-pre">-</span></span>
            <span style="color:#3fb950">Kal <span class="val" id="stat-kal">-</span></span>
            <span style="color:#ff6b6b">Prob <span class="val" id="stat-prob">-</span></span>
            <span>|</span>
            <span>Same-Plat: <span class="val" id="stat-same">0</span></span>
            <span>Cross-Plat: <span class="val" id="stat-cross">0</span></span>
            <span>Multi-result: <span class="val" id="stat-multi" style="color:#58a6ff">0</span></span>
            <span>Cross-Combo: <span class="val" id="stat-cross-combo" style="color:#ff9800">0</span></span>
            <span style="color:#3fb950">Net+: <span class="val" id="stat-profitable" style="color:#3fb950">0</span></span>
            <span>|</span>
            <span>WS: <span class="val" id="stat-ws-updates">0</span> <span id="ws-feed-dot" style="display:inline-block;width:6px;height:6px;border-radius:50%;background:#484f58;vertical-align:middle"></span></span>
        </div>

        <!-- Arbitrage Opportunities -->
        <div class="section-title">Arbitrage Opportunities</div>
        <table class="arb-table">
            <thead>
                <tr>
                    <th>Market</th>
                    <th>Platforms</th>
                    <th>Direction</th>
                    <th>Platform A</th>
                    <th>Platform B</th>
                    <th>Combined</th>
                    <th>Gross</th>
                    <th>Shares</th>
                    <th>Conf</th>
                    <th>Time</th>
                </tr>
            </thead>
            <tbody id="arb-body">
                <tr><td colspan="10" class="empty-state pulse">Scanning markets...</td></tr>
            </tbody>
        </table>

        <!-- Logical Spread Arbitrage -->
        <div class="section-title">
            Logical Spread Arbitrage
            <span style="font-size:12px;font-weight:normal;color:#8b949e;margin-left:6px">— same-platform logical inclusion: P(hard) ≥ P(easy) · price thresholds &amp; time windows</span>
            <span id="lsa-count" style="margin-left:auto;font-size:13px;color:#58a6ff;font-weight:600"></span>
        </div>
        <table class="arb-table">
            <thead>
                <tr>
                    <th>Market</th>
                    <th>Type</th>
                    <th>Key Diff</th>
                    <th>Hard (bid/mid/ask)</th>
                    <th>Easy (bid/mid/ask)</th>
                    <th>Mid Gross</th>
                    <th>Ask Profit</th>
                    <th>Time</th>
                </tr>
            </thead>
            <tbody id="lsa-body">
                <tr><td colspan="8" class="empty-state pulse">Scanning for logical spread opportunities...</td></tr>
            </tbody>
        </table>

        <!-- Multi-result Arbitrage -->
        <div class="section-title">
            Multi-result Arbitrage
            <span style="font-size:12px;font-weight:normal;color:#8b949e;margin-left:6px">— buy all outcomes when total cost &lt; $1 · same-platform (Polymarket) &amp; cross-platform combos (Kalshi+Predict+Opinion)</span>
            <span id="multi-arb-count" style="margin-left:auto;font-size:13px;color:#58a6ff;font-weight:600"></span>
        </div>
        <table class="multi-arb-table">
            <thead>
                <tr>
                    <th>Event</th>
                    <th>Platform</th>
                    <th style="min-width:320px">Outcomes (buy all Yes)</th>
                    <th>Total Cost</th>
                    <th>Gross</th>
                    <th>Shares</th>
                    <th>Time</th>
                </tr>
            </thead>
            <tbody id="multi-arb-body">
                <tr><td colspan="7" class="empty-state pulse">Scanning for multi-outcome opportunities...</td></tr>
            </tbody>
        </table>

        <!-- Market Lists -->
        <div class="section-title">Top Markets by Platform</div>
        <div class="market-lists">
            <div class="market-list">
                <div class="market-list-header">Polymarket</div>
                <div id="list-polymarket"><div class="empty-state">Loading...</div></div>
            </div>
            <div class="market-list">
                <div class="market-list-header">Opinion.trade</div>
                <div id="list-opinion"><div class="empty-state">Loading...</div></div>
            </div>
            <div class="market-list">
                <div class="market-list-header">Predict.fun</div>
                <div id="list-predict"><div class="empty-state">Loading...</div></div>
            </div>
            <div class="market-list">
                <div class="market-list-header">Kalshi</div>
                <div id="list-kalshi"><div class="empty-state">Loading...</div></div>
            </div>
            <div class="market-list">
                <div class="market-list-header">Probable.market</div>
                <div id="list-probable"><div class="empty-state">Loading...</div></div>
            </div>
        </div>
    </div>

    <!-- Socket.IO client -->
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script>
        // ============================================================
        // WebSocket connection with automatic fallback to polling
        // ============================================================
        let useWebSocket = true;
        let pollingInterval = null;
        let socket = null;

        const statusLabels = {
            active: 'Active',
            error: 'Error',
            no_key: 'No API Key',
            unknown: 'Loading...'
        };

        function setWsStatus(status) {
            const dot = document.getElementById('ws-dot');
            const label = document.getElementById('ws-label');
            dot.className = 'ws-dot ' + status;
            if (status === 'connected') {
                label.textContent = 'WebSocket';
            } else if (status === 'disconnected') {
                label.textContent = 'Polling';
            } else {
                label.textContent = 'Connecting...';
            }
        }

        function platformTag(name) {
            const n = name.toLowerCase();
            const cls = n.includes('poly') ? 'poly' :
                        n.includes('opinion') ? 'opinion' :
                        n.includes('kalshi') ? 'kalshi' :
                        n.includes('probable') ? 'probable' :
                        n.includes('cross') ? 'cross' : 'predict';
            return `<span class="tag ${cls}">${name}</span>`;
        }

        function sparklineSvg(points, width, height) {
            if (!points || points.length < 2) return '';
            const vals = points.map(p => p.arb);
            const min = Math.min(...vals), max = Math.max(...vals);
            const range = max - min || 1;
            const step = width / (vals.length - 1);
            const coords = vals.map((v, i) => `${i * step},${height - ((v - min) / range) * height}`);
            const color = vals[vals.length - 1] > 0 ? '#3fb950' : '#f85149';
            return `<span class="sparkline"><svg width="${width}" height="${height}"><polyline points="${coords.join(' ')}" fill="none" stroke="${color}" stroke-width="1.5"/></svg></span>`;
        }

        function arbClass(pct) {
            return pct >= 5 ? 'high' : pct >= 2 ? 'mid' : 'low';
        }

        function netClass(pct) {
            return pct > 0 ? 'high' : pct >= -1 ? 'mid' : 'low';
        }

        function renderLogicalSpreadArb(data) {
            const tbody = document.getElementById('lsa-body');
            const countEl = document.getElementById('lsa-count');
            const arbs = data.logical_spread_arb || [];

            if (countEl) {
                countEl.textContent = arbs.length > 0 ? `${arbs.length} found` : '';
            }

            if (arbs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">No logical spread arbitrage found</td></tr>';
                return;
            }

            // 格式化 bid/mid/ask 三档价格显示
            function priceTriple(bid, mid, ask, hasLiq) {
                const b = bid !== null && bid !== undefined ? bid.toFixed(1) : '-';
                const m = mid !== null && mid !== undefined ? mid.toFixed(1) : (ask !== null ? ask.toFixed(1) : '-');
                const a = ask !== null && ask !== undefined ? ask.toFixed(1) : '-';
                const liqDot = hasLiq ? '' : '<span title="No bid-side liquidity" style="color:#f85149;font-size:10px"> ⚠</span>';
                return `<span style="color:#8b949e;font-size:11px">${b}</span>`
                     + `<span style="color:#58a6ff;font-weight:600;margin:0 2px">${m}</span>`
                     + `<span style="color:#8b949e;font-size:11px">${a}</span>${liqDot}`;
            }

            tbody.innerHTML = arbs.map(a => {
                // Ask profit: 实际可执行利润（更保守）
                const askProfitStr = a.ask_profit !== null && a.ask_profit !== undefined
                    ? `${a.ask_profit}%`
                    : 'N/A';
                const askProfitClass = a.ask_profit > 0 ? 'high' : a.ask_profit !== null ? 'low' : '';

                return `
                <tr class="arb-row">
                    <td><a href="${a.event_url || '#'}" target="_blank" style="color:#03a9f4;font-weight:600;text-decoration:none">${a.event_title || 'Event'}</a></td>
                    <td><span style="font-size:12px;color:#8b949e;background:#21262d;padding:2px 6px;border-radius:4px">${a.type || 'LSA'}</span></td>
                    <td><div class="key-differences"><span class="key-diff-item">${a.hard_market_tag || 'Hard'}</span> <span style="color:#8b949e">→</span> <span class="key-diff-item">${a.easy_market_tag || 'Easy'}</span></div></td>
                    <td style="white-space:nowrap">${priceTriple(a.hard_bid, a.hard_yes, a.hard_ask, a.hard_liq)}</td>
                    <td style="white-space:nowrap">${priceTriple(a.easy_bid, a.easy_yes, a.easy_ask, a.easy_liq)}</td>
                    <td><span class="arb-pct ${arbClass(a.arbitrage)}">${a.arbitrage}%</span></td>
                    <td><span class="arb-pct ${askProfitClass}">${askProfitStr}</span></td>
                    <td style="color:#484f58;font-size:12px">${a.timestamp}</td>
                </tr>`;
            }).join('');
        }

        function renderMultiArb(data) {
            const tbody = document.getElementById('multi-arb-body');
            const countEl = document.getElementById('multi-arb-count');
            const arbs = data.multi_outcome_arb || [];

            const sameCount = arbs.filter(a => a.arb_type === 'multi_outcome').length;
            const comboCount = arbs.filter(a => a.arb_type === 'cross_combo').length;
            if (countEl) {
                if (arbs.length > 0) {
                    const parts = [];
                    if (sameCount > 0) parts.push(sameCount + ' same-platform');
                    if (comboCount > 0) parts.push(comboCount + ' cross-combo');
                    countEl.textContent = parts.join(' · ') + ' found';
                } else {
                    countEl.textContent = '';
                }
            }

            if (arbs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No multi-outcome arbitrage found</td></tr>';
                return;
            }

            tbody.innerHTML = arbs.map(a => {
                // shares: 可购买的股数（两个平台 ask_size 之和，或单方，或 N/A）
                const shares = a.shares;
                const sharesStr = shares !== null && shares !== undefined
                    ? shares.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })
                    : 'N/A';
                const sharesStyle = 'color:#d29922;font-weight:600';  // 黄色显示 shares
                const isCrossCombo = a.arb_type === 'cross_combo';

                // Build outcome pills — for cross-combo show which platform each comes from
                const platColors = {
                    'polymarket': '#03a9f4',
                    'opinion': '#d29922',
                    'predict': '#9c27b0',
                    'kalshi': '#3fb950',
                    'probable': '#ff6b6b',
                };
                const pillsHtml = (a.outcomes || []).map(o => {
                    const platKey = (o.platform || '').toLowerCase();
                    const platColor = platColors[platKey] || '#8b949e';
                    const platTag = isCrossCombo && o.platform
                        ? `<span style="font-size:11px;font-weight:700;color:${platColor};margin-left:3px">[${o.platform.slice(0,3)}]</span>`
                        : '';
                    return `<span class="outcome-pill">` +
                        `<a href="${o.url}" target="_blank" style="text-decoration:none">` +
                        `<span class="outcome-name">${o.name}${platTag}</span>` +
                        `<span class="outcome-price">${(o.price * 100).toFixed(1)}c</span>` +
                        `</a></span>`;
                }).join('');

                // For cross-combo, show abbreviated platform combo in the Platform column
                const platformDisplay = isCrossCombo
                    ? platformTag('Cross')
                    : platformTag(a.platform);

                return `
                <tr class="multi-arb-row${isCrossCombo ? ' cross-combo-row' : ''}">
                    <td><a href="${a.event_url}" target="_blank" style="color:#03a9f4;font-weight:600;text-decoration:none">${a.event_title}</a></td>
                    <td>${platformDisplay}</td>
                    <td><div class="outcome-pills">${pillsHtml}</div></td>
                    <td style="font-weight:600;color:#d29922">${a.total_cost}c</td>
                    <td><span class="arb-pct ${arbClass(a.arbitrage)}">${a.arbitrage}%</span></td>
                    <td><span style="${sharesStyle}">${sharesStr}</span></td>
                    <td style="color:#484f58;font-size:12px">${a.timestamp}</td>
                </tr>`;
            }).join('');
        }

        function renderMarkets(containerId, markets) {
            const el = document.getElementById(containerId);
            if (!markets || markets.length === 0) {
                el.innerHTML = '<div class="empty-state">No data</div>';
                return;
            }
            el.innerHTML = markets.slice(0, 10).map(m => {
                return `
                <div class="market-item">
                    <div class="title">${m.title}</div>
                    <div class="prices">
                        <span>Yes: <span class="yes">${(m.yes * 100).toFixed(1)}c</span></span><span>No: <span class="no">${(m.no * 100).toFixed(1)}c</span></span>
                        <span>Vol: $${Math.round(m.volume).toLocaleString()}</span>
                    </div>
                </div>`;
            }).join('');
        }

        function flashCard(platform) {
            const card = document.getElementById('card-' + platform);
            if (card) {
                card.classList.add('updated');
                setTimeout(() => card.classList.remove('updated'), 1500);
            }
        }

        function updateDashboard(data) {
            if (!data) return;

            // Header
            document.getElementById('scan-count').textContent = data.scan_count || 0;
            document.getElementById('threshold').textContent = (data.threshold || 2.0).toFixed ? (data.threshold || 2.0).toFixed(1) : data.threshold;
            document.getElementById('last-scan').textContent = data.last_scan || '-';

            // Platforms
            ['polymarket', 'opinion', 'predict', 'kalshi', 'probable'].forEach(p => {
                const info = data.platforms[p] || {};
                const dot = document.getElementById(`dot-${p}`);
                dot.className = `status-dot ${info.status || 'unknown'}`;
                document.getElementById(`count-${p}`).textContent = info.count || 0;
                document.getElementById(`status-${p}`).textContent = statusLabels[info.status] || info.status || 'Unknown';
                renderMarkets(`list-${p}`, info.markets);
            });

            // Scan Statistics
            const stats = data.scan_stats;
            if (stats) {
                const el = document.getElementById('scan-stats');
                el.style.display = 'flex';
                document.getElementById('stat-duration').textContent = stats.duration || '-';
                document.getElementById('stat-total').textContent = stats.total_markets || 0;
                document.getElementById('stat-poly').textContent = stats.poly_count || 0;
                document.getElementById('stat-op').textContent = stats.opinion_count || 0;
                document.getElementById('stat-pre').textContent = stats.predict_count || 0;
                document.getElementById('stat-kal').textContent = stats.kalshi_count || 0;
                document.getElementById('stat-prob').textContent = stats.probable_count || 0;
                document.getElementById('stat-same').textContent = stats.same_platform_arb || 0;
                document.getElementById('stat-cross').textContent = stats.cross_platform_arb || 0;
                document.getElementById('stat-multi').textContent = stats.multi_outcome_arb || 0;
                document.getElementById('stat-cross-combo').textContent = stats.cross_combo_arb || 0;
                document.getElementById('stat-profitable').textContent = stats.profitable_after_fees || 0;
                document.getElementById('stat-ws-updates').textContent = stats.ws_updates || 0;
            }

            // WebSocket feed status indicator
            const wsFeed = data.ws_feed;
            if (wsFeed) {
                const dot = document.getElementById('ws-feed-dot');
                const connected = wsFeed.poly_connected || wsFeed.kalshi_connected;
                dot.style.background = connected ? '#3fb950' : '#484f58';
                dot.title = `Poly: ${wsFeed.poly_subscribed || 0} subs (${wsFeed.poly_connected ? 'connected' : 'disconnected'})\nKalshi: ${wsFeed.kalshi_subscribed || 0} subs (${wsFeed.kalshi_connected ? 'connected' : 'disconnected'})`;
            }

            // Logical Spread Arbitrage
            renderLogicalSpreadArb(data);

            // Multi-result Arbitrage
            renderMultiArb(data);

            // Arbitrage
            const tbody = document.getElementById('arb-body');
            const arbs = data.arbitrage || [];
            if (arbs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="empty-state">No arbitrage opportunities found</td></tr>';
            } else {
                tbody.innerHTML = arbs.map(a => {
                    // shares: 可购买的股数
                    const shares = a.shares;
                    const sharesStr = shares !== null && shares !== undefined
                        ? shares.toLocaleString()
                        : 'N/A';
                    const sharesStyle = 'color:#d29922;font-weight:600';
                    const typeIcon = a.arb_type === 'same_platform' ? '&#9679; ' : '';
                    return `
                    <tr${a.arb_type === 'same_platform' ? ' style="background:#1a1a0e"' : ''}>
                        <td>${typeIcon}${a.market}</td>
                        <td>${platformTag(a.platform_a)} ${platformTag(a.platform_b)}</td>
                        <td class="direction">${a.direction}</td>
                        <td>Y:${a.a_yes}c N:${a.a_no}c</td>
                        <td>Y:${a.b_yes}c N:${a.b_no}c</td>
                        <td>${a.combined}c</td>
                        <td><span class="arb-pct ${arbClass(a.arbitrage)}">${a.arbitrage}%</span></td>
                        <td><span style="${sharesStyle}">${sharesStr}</span></td>
                        <td>${(a.confidence * 100).toFixed(0)}%</td>
                        <td>${a.timestamp}</td>
                    </tr>`;
                }).join('');
            }

            // Error display
            if (data.error) {
                console.error('Backend error:', data.error);
            }
        }

        // ============================================================
        // Try WebSocket first, fall back to polling
        // ============================================================
        function initWebSocket() {
            try {
                socket = io({
                    transports: ['websocket', 'polling'],  // Prefer WebSocket
                    reconnection: true,
                    reconnectionDelay: 2000,
                    reconnectionAttempts: 10,
                    timeout: 10000,
                });

                socket.on('connect', function() {
                    console.log('WebSocket connected');
                    useWebSocket = true;
                    setWsStatus('connected');
                    // Stop polling if it was running
                    if (pollingInterval) {
                        clearInterval(pollingInterval);
                        pollingInterval = null;
                    }
                });

                socket.on('state_update', function(data) {
                    updateDashboard(data);
                });

                socket.on('platform_update', function(data) {
                    // Flash the platform card on real-time update
                    flashCard(data.platform);
                });

                socket.on('ws_price_update', function(data) {
                    // Real-time price update from Polymarket/Kalshi WebSocket
                    const dot = document.getElementById('ws-feed-dot');
                    if (dot) {
                        dot.style.background = '#3fb950';
                        dot.style.boxShadow = '0 0 6px #3fb950';
                        setTimeout(() => { dot.style.boxShadow = 'none'; }, 300);
                    }
                    // Update WS counter
                    const wsEl = document.getElementById('stat-ws-updates');
                    if (wsEl) {
                        wsEl.textContent = parseInt(wsEl.textContent || '0') + 1;
                    }
                });

                socket.on('disconnect', function(reason) {
                    console.log('WebSocket disconnected:', reason);
                    setWsStatus('disconnected');
                    // Start polling as fallback
                    startPolling();
                });

                socket.on('connect_error', function(err) {
                    console.warn('WebSocket error, falling back to polling:', err.message);
                    useWebSocket = false;
                    setWsStatus('disconnected');
                    startPolling();
                });

            } catch (e) {
                console.warn('WebSocket not available, using polling:', e);
                useWebSocket = false;
                setWsStatus('disconnected');
                startPolling();
            }
        }

        function startPolling() {
            if (pollingInterval) return;  // Already polling
            console.log('Starting HTTP polling fallback');
            pollingInterval = setInterval(pollState, 10000);
            pollState();  // Immediate first poll
        }

        function pollState() {
            fetch('/api/state')
                .then(r => {
                    if (!r.ok) throw new Error(`HTTP ${r.status}`);
                    return r.json();
                })
                .then(data => updateDashboard(data))
                .catch(e => console.error('Poll error:', e));
        }

        // Start
        initWebSocket();
        // Also do one immediate HTTP fetch for fast initial load
        pollState();
    </script>
</body>
</html>
