# 监控和调试工具

## 本地监控

### 查看运行统计
```bash
python monitor.py stats
```

显示：
- 最后更新时间
- 总扫描次数
- 发现机会数
- Telegram 推送次数
- 错误数

### 查看最新日志
```bash
python monitor.py log
```

显示最后 50 行日志（可通过 `--lines` 参数调整）

### 查看最近的错误
```bash
python monitor.py errors
```

显示最近的错误及上下文

## Railway 部署

### 启动命令
Railway 使用 `start_arbitrage.py` 作为启动包装器，提供额外的错误处理。

### 健康检查
Railway 可使用 `health_check.py` 进行健康检查（可选）。

### 环境变量
确保在 Railway 中设置以下环境变量：
- `TELEGRAM_BOT_TOKEN`
- `TELEGRAM_CHAT_ID`
- `PREDICT_API_KEY`
- `MIN_ARBITRAGE_THRESHOLD` (可选，默认 2.0)
- `SCAN_INTERVAL` (可选，默认 10 秒)

## 改进内容

### 1. 更健壮的错误处理
- 分类处理不同类型的异常（网络、类型、属性等）
- 连续错误计数和自动退避
- 详细的错误日志记录

### 2. Telegram 消息改进
- 正确转义 HTML 特殊字符
- 增加超时时间（15秒）
- 更详细的错误信息

### 3. 心跳和监控
- 每小时输出心跳日志
- 定期输出统计信息
- 改进的 Railway 环境检测

### 4. 启动包装器
- 捕获所有未处理的异常
- 详细的堆栈跟踪记录
- 优雅的退出处理

## 故障排查

### 程序频繁重启
1. 检查 Railway 日志中的错误信息
2. 使用 `python monitor.py errors` 查看错误模式
3. 检查环境变量是否正确配置

### Telegram 推送失败
1. 验证 `TELEGRAM_BOT_TOKEN` 和 `TELEGRAM_CHAT_ID`
2. 检查网络连接
3. 查看具体错误描述

### 内存泄漏
- 当前版本已优化，应该不会出现
- 如果仍有问题，请检查日志中的扫描次数
